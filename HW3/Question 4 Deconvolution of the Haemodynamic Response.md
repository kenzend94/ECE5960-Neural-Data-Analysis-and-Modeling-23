## Question 4: Deconvolution of the Haemodynamic Response
Deconvolution of the Haemodynamic Response. Neuronal activity causes local changes in deoxyhemoglobin concentration in the blood, which can be measured using magnetic resonance imaging (MRI). One drawback of this is that the haemodynamic response is both delayed and slower than the underlying neural responses. We can model the delay and spread of the measurements relative to the neural signals using a linear shift-invariant system:

$$r(n) = \sum_k x(n-k) h(k)$$

where x(n) is an input signal delivered over time (for example, a sequence of light intensities), h(k) is the haemodynamic response to a single light flash at time k = 0 (i.e., the impulse response of the MRI measurement), and r(n) is the MRI response to the full input signal.

In the file ```hrfDeconv.mat```, you will find a response vector r and an input vector x containing a sequence of impulses (indicating flashes of light). Your goal is to estimate the HRF, h, from the data. Each of these signals are sampled at 1 Hz. Plot vectors r and x versus time to get a sense for the data. (Use the ```stem``` command for x, and label the x-axis).


  - (a) Convolution is linear, and thus we can re-write the equation above as a matrix multiplication, r = Xh, where h is a vector of length M, and X is an N + M - 1 x M matrix (N is the length of the input x). Write a matlab function ```createConvMat```, that takes as arguments an input vector x andM (the dimensionality of h) and generates a matrix X such that the response r = Xh is as defined in Eq. (1) for any h. Verify that the matrix generated by your function produces the same response as MatLab’s conv function when applied to a few random h vectors of length M = 15. Visualize the matrix X as an image (evaluate ```imagesc(X)```), and describe its structure.

  - (b) Now, given the X generated by your function for M = 15, solve for h by formulating a least-squares regression problem:

$$
h_{opt}=arg \min{||r-Xh||}^2
$$

   Plot hopt as a function of time (label your x-axis, including units). How would you describe it? How long does it last?

  - (c) It’s often easier to understand an LSI system by viewing it in the frequency domain. Plot the power-spectrum of the HRF (i.e. $\left| \mathcal{F}(h) \right|^2$, where $\mathcal{F}(h)$ is the Fourier transform of the HRF). Plot this with the zero frequency (DC) in the middle, and label the x axis, in Hz. Based on this plot, what kind of filter is the HRF? Specifically, which frequencies does it allow to pass, and which does it block?





### Part a:

Convolution is linear, and thus we can re-write the equation above as a matrix multiplication, r = Xh, where h is a vector of length M, and X is an N + M - 1 x M matrix (N is the length of the input x). Write a matlab function createConvMat, that takes as arguments an input vector x andM (the dimensionality of h) and generates a matrix X such that the response r = Xh is as defined in Eq. (1) for any h. Verify that the matrix generated by your function produces the same response as MatLab’s conv function when applied to a few random h vectors of length M = 15. Visualize the matrix X as an image (evaluate imagesc(X)), and describe its structure.


    
![png](Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_files/Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_4_0.png)
    


    --- Iteration 1 ---
    Convolution Matrix:
    [[0.38404169 0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.5877379  0.38404169 0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.13117746 0.5877379  0.38404169 0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.13117746 0.5877379  0.38404169 0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.13117746 0.5877379  0.38404169 0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.13117746 0.5877379  0.38404169
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.13117746 0.5877379
      0.38404169 0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.13117746
      0.5877379  0.38404169 0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.13117746 0.5877379  0.38404169 0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.13117746 0.5877379  0.38404169 0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.13117746 0.5877379  0.38404169 0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.13117746 0.5877379  0.38404169
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.13117746 0.5877379
      0.38404169 0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.13117746
      0.5877379  0.38404169 0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.13117746 0.5877379  0.38404169]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.13117746 0.5877379 ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.13117746]]
    
    


    
![png](Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_files/Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_5_1.png)
    


    Result from matrix multiplication:
    [0.26026473 0.40808405 0.40544342 0.73340602 0.65661225 0.62486242
     0.57074074 0.34334411 0.48878683 0.52791605 0.45954128 0.54344918
     0.46214027 0.4638454  0.65830531 0.3195844  0.0456674 ]
    
    Result from numpy's convolution:
    [0.26026473 0.40808405 0.40544342 0.73340602 0.65661225 0.62486242
     0.57074074 0.34334411 0.48878683 0.52791605 0.45954128 0.54344918
     0.46214027 0.4638454  0.65830531 0.3195844  0.0456674 ]
    
    Difference between methods:
    [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00  0.00000000e+00 -1.11022302e-16  0.00000000e+00
      0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      5.55111512e-17  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00]
    
    --- Iteration 2 ---
    Convolution Matrix:
    [[0.42505081 0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.84794594 0.42505081 0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.59515942 0.84794594 0.42505081 0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.59515942 0.84794594 0.42505081 0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.59515942 0.84794594 0.42505081 0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.59515942 0.84794594 0.42505081
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.59515942 0.84794594
      0.42505081 0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.59515942
      0.84794594 0.42505081 0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.59515942 0.84794594 0.42505081 0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.59515942 0.84794594 0.42505081 0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.59515942 0.84794594 0.42505081 0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.59515942 0.84794594 0.42505081
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.59515942 0.84794594
      0.42505081 0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.59515942
      0.84794594 0.42505081 0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.59515942 0.84794594 0.42505081]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.59515942 0.84794594]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.59515942]]
    
    


    
![png](Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_files/Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_5_3.png)
    


    Result from matrix multiplication:
    [0.36208403 1.01144877 1.12057984 0.81612215 1.02106789 1.35175733
     1.15092724 0.78148987 0.54265549 0.57558531 0.61576155 0.83493085
     1.3083906  1.1487382  0.77698602 0.71870637 0.49174861]
    
    Result from numpy's convolution:
    [0.36208403 1.01144877 1.12057984 0.81612215 1.02106789 1.35175733
     1.15092724 0.78148987 0.54265549 0.57558531 0.61576155 0.83493085
     1.3083906  1.1487382  0.77698602 0.71870637 0.49174861]
    
    Difference between methods:
    [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00  2.22044605e-16 -2.22044605e-16  1.11022302e-16
     -1.11022302e-16  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00 -2.22044605e-16  0.00000000e+00  0.00000000e+00
      0.00000000e+00]
    
    --- Iteration 3 ---
    Convolution Matrix:
    [[0.46409145 0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.44161195 0.46409145 0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.61371456 0.44161195 0.46409145 0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.61371456 0.44161195 0.46409145 0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.61371456 0.44161195 0.46409145 0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.61371456 0.44161195 0.46409145
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.61371456 0.44161195
      0.46409145 0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.61371456
      0.44161195 0.46409145 0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.61371456 0.44161195 0.46409145 0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.61371456 0.44161195 0.46409145 0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.61371456 0.44161195 0.46409145 0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.61371456 0.44161195 0.46409145
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.61371456 0.44161195
      0.46409145 0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.61371456
      0.44161195 0.46409145 0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.61371456 0.44161195 0.46409145]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.61371456 0.44161195]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.61371456]]
    
    


    
![png](Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_files/Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_5_5.png)
    


    Result from matrix multiplication:
    [0.29665159 0.34126678 0.50677837 0.28980278 0.5905296  0.79792155
     1.16351894 1.16821496 0.99750844 0.93391175 0.50903928 1.03652444
     1.03088854 1.08607276 0.76786956 0.20512298 0.06823468]
    
    Result from numpy's convolution:
    [0.29665159 0.34126678 0.50677837 0.28980278 0.5905296  0.79792155
     1.16351894 1.16821496 0.99750844 0.93391175 0.50903928 1.03652444
     1.03088854 1.08607276 0.76786956 0.20512298 0.06823468]
    
    Difference between methods:
    [ 0.00000000e+00  0.00000000e+00  0.00000000e+00 -5.55111512e-17
      0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00]
    
    --- Iteration 4 ---
    Convolution Matrix:
    [[0.83569022 0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.43549251 0.83569022 0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.18928906 0.43549251 0.83569022 0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.18928906 0.43549251 0.83569022 0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.18928906 0.43549251 0.83569022 0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.18928906 0.43549251 0.83569022
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.18928906 0.43549251
      0.83569022 0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.18928906
      0.43549251 0.83569022 0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.18928906 0.43549251 0.83569022 0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.18928906 0.43549251 0.83569022 0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.18928906 0.43549251 0.83569022 0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.18928906 0.43549251 0.83569022
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.18928906 0.43549251
      0.83569022 0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.18928906
      0.43549251 0.83569022 0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.18928906 0.43549251 0.83569022]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.18928906 0.43549251]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.18928906]]
    
    


    
![png](Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_files/Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_5_7.png)
    


    Result from matrix multiplication:
    [0.11942293 0.76914396 1.02346529 1.06279921 0.78523197 0.82570397
     0.79918713 1.10571299 0.70262917 0.4000851  0.23808007 0.72359452
     0.64015054 0.3722391  0.93022134 0.44763389 0.18648358]
    
    Result from numpy's convolution:
    [0.11942293 0.76914396 1.02346529 1.06279921 0.78523197 0.82570397
     0.79918713 1.10571299 0.70262917 0.4000851  0.23808007 0.72359452
     0.64015054 0.3722391  0.93022134 0.44763389 0.18648358]
    
    Difference between methods:
    [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00 -1.11022302e-16  0.00000000e+00  0.00000000e+00
      0.00000000e+00  0.00000000e+00  0.00000000e+00 -1.11022302e-16
      0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00]
    
    --- Iteration 5 ---
    Convolution Matrix:
    [[0.90991399 0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.1737383  0.90991399 0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.48483879 0.1737383  0.90991399 0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.48483879 0.1737383  0.90991399 0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.48483879 0.1737383  0.90991399 0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.48483879 0.1737383  0.90991399
      0.         0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.48483879 0.1737383
      0.90991399 0.         0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.48483879
      0.1737383  0.90991399 0.         0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.48483879 0.1737383  0.90991399 0.         0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.48483879 0.1737383  0.90991399 0.         0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.48483879 0.1737383  0.90991399 0.
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.48483879 0.1737383  0.90991399
      0.         0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.48483879 0.1737383
      0.90991399 0.         0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.48483879
      0.1737383  0.90991399 0.        ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.48483879 0.1737383  0.90991399]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.48483879 0.1737383 ]
     [0.         0.         0.         0.         0.         0.
      0.         0.         0.         0.         0.         0.
      0.         0.         0.48483879]]
    
    


    
![png](Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_files/Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_5_9.png)
    


    Result from matrix multiplication:
    [0.47602657 0.77916621 1.11582947 0.612199   0.53555818 0.59495643
     0.68452335 0.5190432  0.55391226 0.70999639 0.55552257 0.91843549
     0.85201993 0.45662014 0.99885495 0.15823512 0.36157847]
    
    Result from numpy's convolution:
    [0.47602657 0.77916621 1.11582947 0.612199   0.53555818 0.59495643
     0.68452335 0.5190432  0.55391226 0.70999639 0.55552257 0.91843549
     0.85201993 0.45662014 0.99885495 0.15823512 0.36157847]
    
    Difference between methods:
    [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  1.11022302e-16
      0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
     -1.11022302e-16  0.00000000e+00  0.00000000e+00  0.00000000e+00
      0.00000000e+00]
    
    

The convolution matrix appears to be a diagonal matrix. 

### Part b:
Now, given the X generated by your function for M = 15, solve for h by formulating a least-squares regression problem:

$$
h_{opt}=arg \min{||r-Xh||}^2
$$

   Plot hopt as a function of time (label your x-axis, including units). How would you describe it? How long does it last?

    Shape of x_data: (86,)
    Shape of response_data: (100,)
    
    Optimal h using library function: [ 0.08038615  0.20651242  0.54851395  0.98458329  1.09930568  0.98008733
      0.35467779  0.07621158  0.03380402 -0.10810732 -0.40934496 -0.0687829
     -0.27365116 -0.22476736  0.09256217]
    
    Optimal h using Gaussian elimination: [ 0.08038615  0.20651242  0.54851395  0.98458329  1.09930568  0.98008733
      0.35467779  0.07621158  0.03380402 -0.10810732 -0.40934496 -0.0687829
     -0.27365116 -0.22476736  0.09256217]
    
    Using Gaussian elimination h_opt_gaussian and library function h_opt are approximately the same.
    


    
![png](Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_files/Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_9_0.png)
    


### Part c:

It’s often easier to understand an LSI system by viewing it in the frequency domain. Plot the power-spectrum of the HRF (i.e. $\left| \mathcal{F}(h) \right|^2$, where $\mathcal{F}(h)$ is the Fourier transform of the HRF). Plot this with the zero frequency (DC) in the middle, and label the x axis, in Hz. Based on this plot, what kind of filter is the HRF? Specifically, which frequencies does it allow to pass, and which does it block?


    
![png](Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_files/Question%204%20Deconvolution%20of%20the%20Haemodynamic%20Response_11_0.png)
    


When we look at the power spectrum of the HRF, we're basically seeing which frequencies the most power in the HRF. Think of the HRF as a filter: it's more slow changes (low frequencies) and pass down the quicker, quick changes (high frequencies).
